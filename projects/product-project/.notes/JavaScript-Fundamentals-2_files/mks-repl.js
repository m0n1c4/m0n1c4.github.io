define(["jqconsole", "ace"], function() {


  MKSjsrepl = function(id, code, codeToEval, jasmine){

    var html ='<img src="/play_button.png" id="' + id + '-run" class="run" /><div id="' + id + '-editor" class="editor"></div><div id="' + id + '-test" class="jasmine-results"></div><div class="console"><div id="' + id + '-console" class="hide" ></div></div>'

    $("#" + id).html(html)

    var eid = id + '-editor'
    var cid = id + '-console'
    var tid = id + '-test'

    var jqconsole = $("#" + cid).jqconsole();
    var editor = ace.edit(eid);
    editor.setOptions({
      fontSize: 15,
      minLines: 2, maxLines: 18,
      theme: 'ace/theme/mks'
    });
    editor.renderer.setPadding(8);
    editor.renderer.setScrollMargin(8, 8, 0, 0);
    editor.getSession().setMode("../ace/mode/javascript");

    function log() {
      console.log(arguments);
    }

    var ResultCallback = function(result) {
      if (result) {
        if (result[-1] !== '\n') {
          result = result + '\n';
        }
        jqconsole.Write('=> ' + result, 'jqconsole-output');
      } else {
        jqconsole.Write('=> undefined\n', 'jqconsole-output')
      }
      var el = $("#" + cid).closest(".console");
      el.scrollTop(el[0].scrollHeight);
      return;
    }

    var InputCallback = function(callback) {
      jqconsole.Input(function(result) {
        var e;
        try {
          callback(result);
        } catch (_error) {
          e = _error;
          console.log(e);
        }
      });
      return;
    }

    var parseError = function(error){
      var returnStr= "---------------------\n"
      returnStr += error.message? error.message : "";
      var e, e2;
      if (error.stack){
        e = error.stack.split('\n');
      }
      if (e){
        if (e[1]){
          var iOfAt = e[1].search('at');
          if (iOfAt !== -1){
            returnStr += "\nInside Function: " + e[1].slice(iOfAt).split(" ")[1];
          }
          if (e[1].split(',').length > 1){
            e2 = e[1].split(',')[1].split(':');
            returnStr += "\nLine: " + e2[1] + ", Column: " + e2[2].slice(0,-1);
          }
        }
      }
      return returnStr;
    }

    var ErrorCallback = function(error) {
      if (typeof error === 'object') {
        error = parseError(error);
      }
      if (error[-1] !== '\n') {
        error = error + '\n';
      }
      jqconsole.Write(String(error), 'jqconsole-error');
      var el = $("#" + cid).closest(".console");
      el.scrollTop(el[0].scrollHeight);
      return;
    }

    var OutputCallback = function(output, cls) {
      if (output) {
        var sj = output.search("<<<jasmine>>>>");
        if (sj >= 0){
          var outputText = output.substring(sj,output.length).substring(14,output.length).replace(/<<<jasmine>>>>/g, "");
          $("#" + tid).append(outputText);
        }else{
          jqconsole.Write(output, "jqconsole-output");
        }
        var el = $("#" + cid).closest(".console");
        el.scrollTop(el[0].scrollHeight);
        return;
      }
    }

    var jsrepl = new JSREPL({
      input: InputCallback,
      output: OutputCallback,
      result: ResultCallback,
      error: ErrorCallback,
      progress: function(){},
      timeout: {
        time: 30000,
        callback: log
      }
    });

    jsrepl.loadLanguage("javascript");

    var startPrompt = function () {
      jqconsole.Prompt(true, function (input) {
        jsrepl["eval"](input);
        startPrompt();
      });
    };

    startPrompt();

    $("#" + id + "-run").click(function(){
      $("#" + id + "-console").removeClass("hide");
      if(jasmine){
        $("#" + tid).show();
        $("#" + tid).html("");
        jsrepl.eval("env.topSuite().children = [];");
      }
      jsrepl.eval(editor.getValue());
      if(jasmine){
        jsrepl.eval("env.execute();");
      }
    });

    editor.setValue(code);
    editor.gotoLine(editor.session.getLength());

    jsrepl.on('ready', function(){
      if(jasmine){
        var jasmineJS = "function getJasmineRequireObj(){if(typeof module!==\"undefined\"&&module.exports){return exports}else{window.jasmineRequire=window.jasmineRequire||{};return window.jasmineRequire}}getJasmineRequireObj().core=function(e){var t={};e.base(t);t.util=e.util();t.Any=e.Any();t.CallTracker=e.CallTracker();t.Clock=e.Clock();t.DelayedFunctionScheduler=e.DelayedFunctionScheduler();t.Env=e.Env(t);t.ExceptionFormatter=e.ExceptionFormatter();t.Expectation=e.Expectation();t.buildExpectationResult=e.buildExpectationResult();t.JsApiReporter=e.JsApiReporter();t.matchersUtil=e.matchersUtil(t);t.ObjectContaining=e.ObjectContaining(t);t.pp=e.pp(t);t.QueueRunner=e.QueueRunner();t.ReportDispatcher=e.ReportDispatcher();t.Spec=e.Spec(t);t.SpyStrategy=e.SpyStrategy();t.Suite=e.Suite();t.Timer=e.Timer();t.version=e.version();t.matchers=e.requireMatchers(e,t);return t};getJasmineRequireObj().requireMatchers=function(e,t){var n=[\"toBe\",\"toBeCloseTo\",\"toBeDefined\",\"toBeFalsy\",\"toBeGreaterThan\",\"toBeLessThan\",\"toBeNaN\",\"toBeNull\",\"toBeTruthy\",\"toBeUndefined\",\"toContain\",\"toEqual\",\"toHaveBeenCalled\",\"toHaveBeenCalledWith\",\"toMatch\",\"toThrow\",\"toThrowError\"],r={};for(var i=0;i<n.length;i++){var s=n[i];r[s]=e[s](t)}return r};getJasmineRequireObj().base=function(j$){j$.unimplementedMethod_=function(){throw new Error(\"unimplemented method\")};j$.MAX_PRETTY_PRINT_DEPTH=40;j$.DEFAULT_TIMEOUT_INTERVAL=5e3;j$.getGlobal=function(){var jasmineGlobal=eval.call(null,\"this\");return function(){return jasmineGlobal}}();j$.getEnv=function(e){var t=j$.currentEnv_=j$.currentEnv_||new j$.Env(e);return t};j$.isArray_=function(e){return j$.isA_(\"Array\",e)};j$.isString_=function(e){return j$.isA_(\"String\",e)};j$.isNumber_=function(e){return j$.isA_(\"Number\",e)};j$.isA_=function(e,t){return Object.prototype.toString.apply(t)===\"[object \"+e+\"]\"};j$.isDomNode=function(e){return e.nodeType>0};j$.any=function(e){return new j$.Any(e)};j$.objectContaining=function(e){return new j$.ObjectContaining(e)};j$.createSpy=function(e,t){var n=new j$.SpyStrategy({name:e,fn:t,getSpy:function(){return i}}),r=new j$.CallTracker,i=function(){r.track({object:this,args:Array.prototype.slice.apply(arguments)});return n.exec.apply(this,arguments)};for(var s in t){if(s===\"and\"||s===\"calls\"){throw new Error(\"Jasmine spies would overwrite the \'and\' and \'calls\' properties on the object being spied upon\")}i[s]=t[s]}i.and=n;i.calls=r;return i};j$.isSpy=function(e){if(!e){return false}return e.and instanceof j$.SpyStrategy&&e.calls instanceof j$.CallTracker};j$.createSpyObj=function(e,t){if(!j$.isArray_(t)||t.length===0){throw\"createSpyObj requires a non-empty array of method names to create spies for\"}var n={};for(var r=0;r<t.length;r++){n[t[r]]=j$.createSpy(e+\".\"+t[r])}return n}};getJasmineRequireObj().util=function(){var e={};e.inherit=function(e,t){var n=function(){};n.prototype=t.prototype;e.prototype=new n};e.htmlEscape=function(e){if(!e){return e}return e.replace(\/&\/g,\"&\").replace(\/<\/g,\"&lt;\").replace(\/>\/g,\"&gt;\")};e.argsToArray=function(e){var t=[];for(var n=0;n<e.length;n++){t.push(e[n])}return t};e.isUndefined=function(e){return e===void 0};return e};getJasmineRequireObj().Spec=function(e){function t(e){this.expectationFactory=e.expectationFactory;this.resultCallback=e.resultCallback||function(){};this.id=e.id;this.description=e.description||\"\";this.fn=e.fn;this.beforeFns=e.beforeFns||function(){return[]};this.afterFns=e.afterFns||function(){return[]};this.onStart=e.onStart||function(){};this.exceptionFormatter=e.exceptionFormatter||function(){};this.getSpecName=e.getSpecName||function(){return\"\"};this.expectationResultFactory=e.expectationResultFactory||function(){};this.queueRunnerFactory=e.queueRunnerFactory||function(){};this.catchingExceptions=e.catchingExceptions||function(){return true};this.timer=e.timer||{setTimeout:setTimeout,clearTimeout:clearTimeout};if(!this.fn){this.pend()}this.result={id:this.id,description:this.description,fullName:this.getFullName(),failedExpectations:[]}}t.prototype.addExpectationResult=function(e,t){if(e){return}this.result.failedExpectations.push(this.expectationResultFactory(t))};t.prototype.expect=function(e){return this.expectationFactory(e,this)};t.prototype.execute=function(n){function s(t){return function(n){i=Function.prototype.apply.apply(r.timer.setTimeout,[e.getGlobal(),[function(){c(new Error(\"Timeout - Async callback was not invoked within timeout specified by jasmine.DEFAULT_TIMEOUT_INTERVAL.\"));n()},e.DEFAULT_TIMEOUT_INTERVAL]]);var s=function(){o();n()};t.call(this,s)}}function o(){Function.prototype.apply.apply(r.timer.clearTimeout,[e.getGlobal(),[i]]);i=void 0}function c(e){o();if(t.isPendingSpecException(e)){r.pend();return}r.addExpectationResult(false,{matcherName:\"\",passed:false,expected:\"\",actual:\"\",error:e})}function h(){r.result.status=r.status();r.resultCallback(r.result);if(n){n()}}var r=this,i;this.onStart(this);if(this.markedPending||this.disabled){h();return}var u=this.beforeFns().concat(this.fn).concat(this.afterFns()),a=[];for(var f=0;f<u.length;f++){var l=u[f];a.push(l.length>0?s(l):l)}this.queueRunnerFactory({fns:a,onException:c,onComplete:h})};t.prototype.disable=function(){this.disabled=true};t.prototype.pend=function(){this.markedPending=true};t.prototype.status=function(){if(this.disabled){return\"disabled\"}if(this.markedPending){return\"pending\"}if(this.result.failedExpectations.length>0){return\"failed\"}else{return\"passed\"}};t.prototype.getFullName=function(){return this.getSpecName(this)};t.pendingSpecExceptionMessage=\"=> marked Pending\";t.isPendingSpecException=function(e){return e.toString().indexOf(t.pendingSpecExceptionMessage)!==-1};return t};if(typeof window==void 0&&typeof exports==\"object\"){exports.Spec=jasmineRequire.Spec}getJasmineRequireObj().Env=function(e){function t(t){function A(e){L++;if(L>=k){L=0;o(e,0)}else{e()}}t=t||{};var n=this;var r=t.global||e.getGlobal();var i=0;var s=true;var o=e.getGlobal().setTimeout;var u=e.getGlobal().clearTimeout;this.clock=new e.Clock(r,new e.DelayedFunctionScheduler);var a={};var f=[];var l=null;var c=null;var h=new e.ReportDispatcher([\"jasmineStarted\",\"jasmineDone\",\"suiteStarted\",\"suiteDone\",\"specStarted\",\"specDone\"]);this.specFilter=function(){return true};var p=[];var d=[];this.addCustomEqualityTester=function(e){d.push(e)};e.Expectation.addCoreMatchers(e.matchers);var v=0;var m=function(){return\"spec\"+v++};var g=0;var y=function(){return\"suite\"+g++};var b=function(t,n){function r(e,t){return n.addExpectationResult(e,t)}return e.Expectation.Factory({util:e.matchersUtil,customEqualityTesters:d,actual:t,addExpectationResult:r})};var w=function(e){l=e;h.specStarted(e.result)};var E=function(e){return function(){var t=[];while(e){t=t.concat(e.beforeFns);e=e.parentSuite}return t.reverse()}};var S=function(e){return function(){var t=[];while(e){t=t.concat(e.afterFns);e=e.parentSuite}return t}};var x=function(e,t){return t.getFullName()+\" \"+e.description};var T=e.buildExpectationResult,N=new e.ExceptionFormatter,C=function(e){e.messageFormatter=N.message;e.stackFormatter=N.stack;return T(e)};this.catchExceptions=function(e){s=!!e;return s};this.catchingExceptions=function(){return s};var k=20;var L=0;var O=function(t){return e.Spec.isPendingSpecException(t)||s};var M=function(t){t.catchException=O;t.clearStack=t.clearStack||A;(new e.QueueRunner(t)).execute()};var _=new e.Suite({env:this,id:y(),description:\"Jasmine__TopLevel__Suite\",queueRunner:M,resultCallback:function(){}});a[_.id]=_;c=_;this.topSuite=function(){return _};this.execute=function(e){e=e||[_.id];var t=[];for(var n=0;n<e.length;n++){var r=a[e[n]];t.push(function(e){return function(t){e.execute(t)}}(r))}h.jasmineStarted({totalSpecsDefined:i});M({fns:t,onComplete:h.jasmineDone})};this.addReporter=function(e){h.addReporter(e)};this.addMatchers=function(t){e.Expectation.addMatchers(t)};this.spyOn=function(t,n){if(e.util.isUndefined(t)){throw new Error(\"spyOn could not find an object to spy upon for \"+n+\"()\")}if(e.util.isUndefined(t[n])){throw new Error(n+\"() method does not exist\")}if(t[n]&&e.isSpy(t[n])){throw new Error(n+\" has already been spied upon\")}var r=e.createSpy(n,t[n]);f.push({spy:r,baseObj:t,methodName:n,originalValue:t[n]});t[n]=r;return r};var D=function(t){var r=new e.Suite({env:n,id:y(),description:t,parentSuite:c,queueRunner:M,onStart:H,resultCallback:function(e){h.suiteDone(e)}});a[r.id]=r;return r};this.describe=function(e,t){var n=D(e);var r=c;r.addChild(n);c=n;var i=null;try{t.call(n)}catch(s){i=s}if(i){this.it(\"encountered a declaration exception\",function(){throw i})}c=r;return n};this.xdescribe=function(e,t){var n=this.describe(e,t);n.disable();return n};var P=function(t,r,s){function p(){for(var e=0;e<f.length;e++){var t=f[e];t.baseObj[t.methodName]=t.originalValue}f=[]}function v(t){p();e.Expectation.resetMatchers();d=[];l=null;h.specDone(t)}i++;var c=new e.Spec({id:m(),beforeFns:E(s),afterFns:S(s),expectationFactory:b,exceptionFormatter:N,resultCallback:v,getSpecName:function(e){return x(e,s)},onStart:w,description:t,expectationResultFactory:C,queueRunnerFactory:M,fn:r,timer:{setTimeout:o,clearTimeout:u}});a[c.id]=c;if(!n.specFilter(c)){c.disable()}return c};var H=function(e){h.suiteStarted(e.result)};this.it=function(e,t){var n=P(e,t,c);c.addChild(n);return n};this.xit=function(e,t){var n=this.it(e,t);n.pend();return n};this.expect=function(e){return l.expect(e)};this.beforeEach=function(e){c.beforeEach(e)};this.afterEach=function(e){c.afterEach(e)};this.pending=function(){throw e.Spec.pendingSpecExceptionMessage}}return t};getJasmineRequireObj().JsApiReporter=function(){function t(t){function o(e){s[e.id]=e}var n=t.timer||e,r=\"loaded\";this.started=false;this.finished=false;this.jasmineStarted=function(){this.started=true;r=\"started\";n.start()};var i;this.jasmineDone=function(){this.finished=true;i=n.elapsed();r=\"done\"};this.status=function(){return r};var s={};this.suiteStarted=function(e){o(e)};this.suiteDone=function(e){o(e)};this.suites=function(){return s};var u=[];this.specStarted=function(e){};this.specDone=function(e){u.push(e)};this.specResults=function(e,t){return u.slice(e,e+t)};this.specs=function(){return u};this.executionTime=function(){return i}}var e={start:function(){},elapsed:function(){return 0}};return t};getJasmineRequireObj().Any=function(){function e(e){this.expectedObject=e}e.prototype.jasmineMatches=function(e){if(this.expectedObject==String){return typeof e==\"string\"||e instanceof String}if(this.expectedObject==Number){return typeof e==\"number\"||e instanceof Number}if(this.expectedObject==Function){return typeof e==\"function\"||e instanceof Function}if(this.expectedObject==Object){return typeof e==\"object\"}if(this.expectedObject==Boolean){return typeof e==\"boolean\"}return e instanceof this.expectedObject};e.prototype.jasmineToString=function(){return\"<jasmine.any(\"+this.expectedClass+\")>\"};return e};getJasmineRequireObj().CallTracker=function(){function e(){var e=[];this.track=function(t){e.push(t)};this.any=function(){return!!e.length};this.count=function(){return e.length};this.argsFor=function(t){var n=e[t];return n?n.args:[]};this.all=function(){return e};this.allArgs=function(){var t=[];for(var n=0;n<e.length;n++){t.push(e[n].args)}return t};this.first=function(){return e[0]};this.mostRecent=function(){return e[e.length-1]};this.reset=function(){e=[]}}return e};getJasmineRequireObj().Clock=function(){function e(e,t){function u(){return!(r.setTimeout||r.setInterval).apply}function a(e,t){for(var n in t){e[n]=t[n]}}function f(e,n){return t.scheduleFunction(e,n,p(arguments,2))}function l(e){return t.removeFunctionWithId(e)}function c(e,n){return t.scheduleFunction(e,n,p(arguments,2),true)}function h(e){return t.removeFunctionWithId(e)}function p(e,t){return Array.prototype.slice.call(e,2)}var n=this,r={setTimeout:e.setTimeout,clearTimeout:e.clearTimeout,setInterval:e.setInterval,clearInterval:e.clearInterval},i={setTimeout:f,clearTimeout:l,setInterval:c,clearInterval:h},s=false,o;n.install=function(){a(e,i);o=i;s=true};n.uninstall=function(){t.reset();a(e,r);o=r;s=false};n.setTimeout=function(t,n,r){if(u()){if(arguments.length>2){throw new Error(\"IE < 9 cannot support extra params to setTimeout without a polyfill\")}return o.setTimeout(t,n)}return Function.prototype.apply.apply(o.setTimeout,[e,arguments])};n.setInterval=function(t,n,r){if(u()){if(arguments.length>2){throw new Error(\"IE < 9 cannot support extra params to setInterval without a polyfill\")}return o.setInterval(t,n)}return Function.prototype.apply.apply(o.setInterval,[e,arguments])};n.clearTimeout=function(t){return Function.prototype.call.apply(o.clearTimeout,[e,t])};n.clearInterval=function(t){return Function.prototype.call.apply(o.clearInterval,[e,t])};n.tick=function(e){if(s){t.tick(e)}else{throw new Error(\"Mock clock is not installed, use jasmine.clock().install()\")}};return n}return e};getJasmineRequireObj().DelayedFunctionScheduler=function(){function DelayedFunctionScheduler(){function indexOfFirstToPass(e,t){var n=-1;for(var r=0;r<e.length;++r){if(t(e[r])){n=r;break}}return n}function deleteFromLookup(e){var t=Number(e);var n=indexOfFirstToPass(scheduledLookup,function(e){return e===t});if(n>-1){scheduledLookup.splice(n,1)}}function reschedule(e){self.scheduleFunction(e.funcToCall,e.millis,e.params,true,e.timeoutKey,e.runAtMillis+e.millis)}function runScheduledFunctions(e){if(scheduledLookup.length===0||scheduledLookup[0]>e){return}do{currentTime=scheduledLookup.shift();var t=scheduledFunctions[currentTime];delete scheduledFunctions[currentTime];for(var n=0;n<t.length;++n){var r=t[n];r.funcToCall.apply(null,r.params||[]);if(r.recurring){reschedule(r)}}}while(scheduledLookup.length>0&&currentTime!==e&&scheduledLookup[0]<=e)}var self=this;var scheduledLookup=[];var scheduledFunctions={};var currentTime=0;var delayedFnCount=0;self.tick=function(e){e=e||0;var t=currentTime+e;runScheduledFunctions(t);currentTime=t};self.scheduleFunction=function(funcToCall,millis,params,recurring,timeoutKey,runAtMillis){var f;if(typeof funcToCall===\"string\"){f=function(){return eval(funcToCall)}}else{f=funcToCall}millis=millis||0;timeoutKey=timeoutKey||++delayedFnCount;runAtMillis=runAtMillis||currentTime+millis;var funcToSchedule={runAtMillis:runAtMillis,funcToCall:f,recurring:recurring,params:params,timeoutKey:timeoutKey,millis:millis};if(runAtMillis in scheduledFunctions){scheduledFunctions[runAtMillis].push(funcToSchedule)}else{scheduledFunctions[runAtMillis]=[funcToSchedule];scheduledLookup.push(runAtMillis);scheduledLookup.sort(function(e,t){return e-t})}return timeoutKey};self.removeFunctionWithId=function(e){for(var t in scheduledFunctions){var n=scheduledFunctions[t];var r=indexOfFirstToPass(n,function(t){return t.timeoutKey===e});if(r>-1){if(n.length===1){delete scheduledFunctions[t];deleteFromLookup(t)}else{n.splice(r,1)}break}}};self.reset=function(){currentTime=0;scheduledLookup=[];scheduledFunctions={};delayedFnCount=0};return self}return DelayedFunctionScheduler};getJasmineRequireObj().ExceptionFormatter=function(){function e(){this.message=function(e){var t=e.name+\": \"+e.message;if(e.fileName||e.sourceURL){t+=\" in \"+(e.fileName||e.sourceURL)}if(e.line||e.lineNumber){t+=\" (line \"+(e.line||e.lineNumber)+\")\"}return t};this.stack=function(e){return e?e.stack:null}}return e};getJasmineRequireObj().Expectation=function(){function t(t){this.util=t.util||{buildFailureMessage:function(){}};this.customEqualityTesters=t.customEqualityTesters||[];this.actual=t.actual;this.addExpectationResult=t.addExpectationResult||function(){};this.isNot=t.isNot;for(var n in e){this[n]=e[n]}}var e={};t.prototype.wrapCompare=function(e,t){return function(){function u(){var e=s.compare.apply(null,n);e.pass=!e.pass;return e}var n=Array.prototype.slice.call(arguments,0),r=n.slice(0),i=\"\";n.unshift(this.actual);var s=t(this.util,this.customEqualityTesters),o=s.compare;if(this.isNot){o=s.negativeCompare||u}var a=o.apply(null,n);if(!a.pass){if(!a.message){n.unshift(this.isNot);n.unshift(e);i=this.util.buildFailureMessage.apply(null,n)}else{i=a.message}}if(r.length==1){r=r[0]}this.addExpectationResult(a.pass,{matcherName:e,passed:a.pass,message:i,actual:this.actual,expected:r})}};t.addCoreMatchers=function(e){var n=t.prototype;for(var r in e){var i=e[r];n[r]=n.wrapCompare(r,i)}};t.addMatchers=function(n){for(var r in n){var i=n[r];e[r]=t.prototype.wrapCompare(r,i)}};t.resetMatchers=function(){for(var t in e){delete e[t]}};t.Factory=function(e){e=e||{};var n=new t(e);e.isNot=true;n.not=new t(e);return n};return t};getJasmineRequireObj().buildExpectationResult=function(){function e(e){function r(){if(e.passed){return\"Passed.\"}else if(e.message){return e.message}else if(e.error){return t(e.error)}return\"\"}function i(){if(e.passed){return\"\"}var t=e.error;if(!t){try{throw new Error(r())}catch(i){t=i}}return n(t)}var t=e.messageFormatter||function(){},n=e.stackFormatter||function(){};return{matcherName:e.matcherName,expected:e.expected,actual:e.actual,message:r(),stack:i(),passed:e.passed}}return e};getJasmineRequireObj().ObjectContaining=function(e){function t(e){this.sample=e}t.prototype.jasmineMatches=function(t,n,r){if(typeof this.sample!==\"object\"){throw new Error(\"You must provide an object to objectContaining, not \'\"+this.sample+\"\'.\")}n=n||[];r=r||[];var i=function(t,n){return t!==null&&!e.util.isUndefined(t[n])};for(var s in this.sample){if(!i(t,s)&&i(this.sample,s)){n.push(\"expected has key \'\"+s+\"\', but missing from actual.\")}else if(!e.matchersUtil.equals(this.sample[s],t[s])){r.push(\"\'\"+s+\"\' was \'\"+(t[s]?e.util.htmlEscape(t[s].toString()):t[s])+\"\' in actual, but was \'\"+(this.sample[s]?e.util.htmlEscape(this.sample[s].toString()):this.sample[s])+\"\' in expected.\")}}return n.length===0&&r.length===0};t.prototype.jasmineToString=function(){return\"<jasmine.objectContaining(\"+e.pp(this.sample)+\")>\"};return t};getJasmineRequireObj().pp=function(e){function t(){this.ppNestLevel_=0}function n(){t.call(this);this.string=\"\"}t.prototype.format=function(t){this.ppNestLevel_++;try{if(e.util.isUndefined(t)){this.emitScalar(\"undefined\")}else if(t===null){this.emitScalar(\"null\")}else if(t===e.getGlobal()){this.emitScalar(\"<global>\")}else if(t.jasmineToString){this.emitScalar(t.jasmineToString())}else if(typeof t===\"string\"){this.emitString(t)}else if(e.isSpy(t)){this.emitScalar(\"spy on \"+t.and.identity())}else if(t instanceof RegExp){this.emitScalar(t.toString())}else if(typeof t===\"function\"){this.emitScalar(\"Function\")}else if(typeof t.nodeType===\"number\"){this.emitScalar(\"HTMLNode\")}else if(t instanceof Date){this.emitScalar(\"Date(\"+t+\")\")}else if(t.__Jasmine_been_here_before__){this.emitScalar(\"<circular reference: \"+(e.isArray_(t)?\"Array\":\"Object\")+\">\")}else if(e.isArray_(t)||e.isA_(\"Object\",t)){t.__Jasmine_been_here_before__=true;if(e.isArray_(t)){this.emitArray(t)}else{this.emitObject(t)}delete t.__Jasmine_been_here_before__}else{this.emitScalar(t.toString())}}finally{this.ppNestLevel_--}};t.prototype.iterateObject=function(t,n){for(var r in t){if(!t.hasOwnProperty(r)){continue}if(r==\"__Jasmine_been_here_before__\"){continue}n(r,t.__lookupGetter__?!e.util.isUndefined(t.__lookupGetter__(r))&&t.__lookupGetter__(r)!==null:false)}};t.prototype.emitArray=e.unimplementedMethod_;t.prototype.emitObject=e.unimplementedMethod_;t.prototype.emitScalar=e.unimplementedMethod_;t.prototype.emitString=e.unimplementedMethod_;e.util.inherit(n,t);n.prototype.emitScalar=function(e){this.append(e)};n.prototype.emitString=function(e){this.append(\"\'\"+e+\"\'\")};n.prototype.emitArray=function(t){if(this.ppNestLevel_>e.MAX_PRETTY_PRINT_DEPTH){this.append(\"Array\");return}this.append(\"[ \");for(var n=0;n<t.length;n++){if(n>0){this.append(\", \")}this.format(t[n])}this.append(\" ]\")};n.prototype.emitObject=function(t){if(this.ppNestLevel_>e.MAX_PRETTY_PRINT_DEPTH){this.append(\"Object\");return}var n=this;this.append(\"{ \");var r=true;this.iterateObject(t,function(e,i){if(r){r=false}else{n.append(\", \")}n.append(e);n.append(\" : \");if(i){n.append(\"<getter>\")}else{n.format(t[e])}});this.append(\" }\")};n.prototype.append=function(e){this.string+=e};return function(e){var t=new n;t.format(e);return t.string}};getJasmineRequireObj().QueueRunner=function(){function e(e){this.fns=e.fns||[];this.onComplete=e.onComplete||function(){};this.clearStack=e.clearStack||function(e){e()};this.onException=e.onException||function(){};this.catchException=e.catchException||function(){return true};this.userContext={}}e.prototype.execute=function(){this.run(this.fns,0)};e.prototype.run=function(e,t){function u(e){try{e.call(r.userContext)}catch(t){f(t)}}function a(t){var n=function(){r.run(e,i+1)};try{t.call(r.userContext,n)}catch(s){f(s);n()}}function f(e){r.onException(e);if(!r.catchException(e)){throw e}}var n=e.length,r=this,i;for(i=t;i<n;i++){var s=e[i];if(s.length>0){return a(s)}else{u(s)}}var o=i>=n;if(o){this.clearStack(this.onComplete)}};return e};getJasmineRequireObj().ReportDispatcher=function(){function e(e){function s(e,t){for(var n=0;n<i.length;n++){var r=i[n];if(r[e]){r[e].apply(r,t)}}}var t=e||[];for(var n=0;n<t.length;n++){var r=t[n];this[r]=function(e){return function(){s(e,arguments)}}(r)}var i=[];this.addReporter=function(e){i.push(e)};return this}return e};getJasmineRequireObj().SpyStrategy=function(){function e(e){e=e||{};var t=e.name||\"unknown\",n=e.fn||function(){},r=e.getSpy||function(){},i=function(){};this.identity=function(){return t};this.exec=function(){return i.apply(this,arguments)};this.callThrough=function(){i=n;return r()};this.returnValue=function(e){i=function(){return e};return r()};this.throwError=function(e){var t=e instanceof Error?e:new Error(e);i=function(){throw t};return r()};this.callFake=function(e){i=e;return r()};this.stub=function(e){i=function(){};return r()}}return e};getJasmineRequireObj().Suite=function(){function e(e){this.env=e.env;this.id=e.id;this.parentSuite=e.parentSuite;this.description=e.description;this.onStart=e.onStart||function(){};this.resultCallback=e.resultCallback||function(){};this.clearStack=e.clearStack||function(e){e()};this.beforeFns=[];this.afterFns=[];this.queueRunner=e.queueRunner||function(){};this.disabled=false;this.children=[];this.result={id:this.id,status:this.disabled?\"disabled\":\"\",description:this.description,fullName:this.getFullName()}}e.prototype.getFullName=function(){var e=this.description;for(var t=this.parentSuite;t;t=t.parentSuite){if(t.parentSuite){e=t.description+\" \"+e}}return e};e.prototype.disable=function(){this.disabled=true};e.prototype.beforeEach=function(e){this.beforeFns.unshift(e)};e.prototype.afterEach=function(e){this.afterFns.unshift(e)};e.prototype.addChild=function(e){this.children.push(e)};e.prototype.execute=function(e){function i(){t.resultCallback(t.result);if(e){e()}}function s(e){return function(t){e.execute(t)}}var t=this;if(this.disabled){i();return}var n=[];for(var r=0;r<this.children.length;r++){n.push(s(this.children[r]))}this.onStart(this);this.queueRunner({fns:n,onComplete:i})};return e};if(typeof window==void 0&&typeof exports==\"object\"){exports.Suite=jasmineRequire.Suite}getJasmineRequireObj().Timer=function(){function e(e){e=e||{};var t=e.now||function(){return(new Date).getTime()},n;this.start=function(){n=t()};this.elapsed=function(){return t()-n}}return e};getJasmineRequireObj().matchersUtil=function(e){function t(n,r,i,s,o){function m(e,t){return e.hasOwnProperty(t)}function g(e){return typeof e===\"function\"}var u=true;for(var a=0;a<o.length;a++){var f=o[a](n,r);if(!e.util.isUndefined(f)){return f}}if(n instanceof e.Any){u=n.jasmineMatches(r);if(u){return true}}if(r instanceof e.Any){u=r.jasmineMatches(n);if(u){return true}}if(r instanceof e.ObjectContaining){u=r.jasmineMatches(n);if(u){return true}}if(n instanceof Error&&r instanceof Error){return n.message==r.message}if(n===r){return n!==0||1\/n==1\/r}if(n===null||r===null){return n===r}var l=Object.prototype.toString.call(n);if(l!=Object.prototype.toString.call(r)){return false}switch(l){case\"[object String]\":return n==String(r);case\"[object Number]\":return n!=+n?r!=+r:n===0?1\/n==1\/r:n==+r;case\"[object Date]\":case\"[object Boolean]\":return+n==+r;case\"[object RegExp]\":return n.source==r.source&&n.global==r.global&&n.multiline==r.multiline&&n.ignoreCase==r.ignoreCase}if(typeof n!=\"object\"||typeof r!=\"object\"){return false}var c=i.length;while(c--){if(i[c]==n){return s[c]==r}}i.push(n);s.push(r);var h=0;if(l==\"[object Array]\"){h=n.length;u=h==r.length;if(u){while(h--){if(!(u=t(n[h],r[h],i,s,o))){break}}}}else{var p=n.constructor,d=r.constructor;if(p!==d&&!(g(p)&&p instanceof p&&g(d)&&d instanceof d)){return false}for(var v in n){if(m(n,v)){h++;if(!(u=m(r,v)&&t(n[v],r[v],i,s,o))){break}}}if(u){for(v in r){if(m(r,v)&&!(h--)){break}}u=!h}}i.pop();s.pop();return u}return{equals:function(e,n,r){r=r||[];return t(e,n,[],[],r)},contains:function(e,n,r){r=r||[];if(Object.prototype.toString.apply(e)===\"[object Array]\"){for(var i=0;i<e.length;i++){if(t(e[i],n,[],[],r)){return true}}return false}return e.indexOf(n)>=0},buildFailureMessage:function(){var t=Array.prototype.slice.call(arguments,0),n=t[0],r=t[1],i=t[2],s=t.slice(3),o=n.replace(\/[A-Z]\/g,function(e){return\" \"+e.toLowerCase()});var u=\"Expected \"+e.pp(i)+(r?\" not \":\" \")+o;if(s.length>0){for(var a=0;a<s.length;a++){if(a>0){u+=\",\"}u+=\" \"+e.pp(s[a])}}return u+\".\"}}};getJasmineRequireObj().toBe=function(){function e(){return{compare:function(e,t){return{pass:e===t}}}}return e};getJasmineRequireObj().toBeCloseTo=function(){function e(){return{compare:function(e,t,n){if(n!==0){n=n||2}return{pass:Math.abs(t-e)<Math.pow(10,-n)\/2}}}}return e};getJasmineRequireObj().toBeDefined=function(){function e(){return{compare:function(e){return{pass:void 0!==e}}}}return e};getJasmineRequireObj().toBeFalsy=function(){function e(){return{compare:function(e){return{pass:!!!e}}}}return e};getJasmineRequireObj().toBeGreaterThan=function(){function e(){return{compare:function(e,t){return{pass:e>t}}}}return e};getJasmineRequireObj().toBeLessThan=function(){function e(){return{compare:function(e,t){return{pass:e<t}}}}return e};getJasmineRequireObj().toBeNaN=function(e){function t(){return{compare:function(t){var n={pass:t!==t};if(n.pass){n.message=\"Expected actual not to be NaN.\"}else{n.message=\"Expected \"+e.pp(t)+\" to be NaN.\"}return n}}}return t};getJasmineRequireObj().toBeNull=function(){function e(){return{compare:function(e){return{pass:e===null}}}}return e};getJasmineRequireObj().toBeTruthy=function(){function e(){return{compare:function(e){return{pass:!!e}}}}return e};getJasmineRequireObj().toBeUndefined=function(){function e(){return{compare:function(e){return{pass:void 0===e}}}}return e};getJasmineRequireObj().toContain=function(){function e(e,t){t=t||[];return{compare:function(n,r){return{pass:e.contains(n,r,t)}}}}return e};getJasmineRequireObj().toEqual=function(){function e(e,t){t=t||[];return{compare:function(n,r){var i={pass:false};i.pass=e.equals(n,r,t);return i}}}return e};getJasmineRequireObj().toHaveBeenCalled=function(e){function t(){return{compare:function(t){var n={};if(!e.isSpy(t)){throw new Error(\"Expected a spy, but got \"+e.pp(t)+\".\")}if(arguments.length>1){throw new Error(\"toHaveBeenCalled does not take arguments, use toHaveBeenCalledWith\")}n.pass=t.calls.any();n.message=n.pass?\"Expected spy \"+t.and.identity()+\" not to have been called.\":\"Expected spy \"+t.and.identity()+\" to have been called.\";return n}}}return t};getJasmineRequireObj().toHaveBeenCalledWith=function(e){function t(t){return{compare:function(){var n=Array.prototype.slice.call(arguments,0),r=n[0],i=n.slice(1),s={pass:false};if(!e.isSpy(r)){throw new Error(\"Expected a spy, but got \"+e.pp(r)+\".\")}if(!r.calls.any()){s.message=\"Expected spy \"+r.and.identity()+\" to have been called with \"+e.pp(i)+\" but it was never called.\";return s}if(t.contains(r.calls.allArgs(),i)){s.pass=true;s.message=\"Expected spy \"+r.and.identity()+\" not to have been called with \"+e.pp(i)+\" but it was.\"}else{s.message=\"Expected spy \"+r.and.identity()+\" to have been called with \"+e.pp(i)+\" but actual calls were \"+e.pp(r.calls.allArgs()).replace(\/^\\[ | \\]$\/g,\"\")+\".\"}return s}}}return t};getJasmineRequireObj().toMatch=function(){function e(){return{compare:function(e,t){var n=new RegExp(t);return{pass:n.test(e)}}}}return e};getJasmineRequireObj().toThrow=function(e){function t(t){return{compare:function(n,r){var i={pass:false},s=false,o;if(typeof n!=\"function\"){throw new Error(\"Actual is not a Function\")}try{n()}catch(u){s=true;o=u}if(!s){i.message=\"Expected function to throw an exception.\";return i}if(arguments.length==1){i.pass=true;i.message=\"Expected function not to throw, but it threw \"+e.pp(o)+\".\";return i}if(t.equals(o,r)){i.pass=true;i.message=\"Expected function not to throw \"+e.pp(r)+\".\"}else{i.message=\"Expected function to throw \"+e.pp(r)+\", but it threw \"+e.pp(o)+\".\"}return i}}}return t};getJasmineRequireObj().toThrowError=function(e){function t(t){return{compare:function(n){function c(e){return e.name||e.toString().match(\/^\\s*function\\s*(\\w*)\\s*\\(\/)[1]}function h(e){return{pass:true,message:e}}function p(e){return{pass:false,message:e}}function d(){if(arguments.length==1){return}if(arguments.length==2){var e=arguments[1];if(e instanceof RegExp){u=e}else if(typeof e==\"string\"){o=e}else if(v(e)){s=e}if(!(s||o||u)){throw new Error(\"Expected is not an Error, string, or RegExp.\")}}else{if(v(arguments[1])){s=arguments[1]}else{throw new Error(\"Expected error type is not an Error.\")}if(arguments[2]instanceof RegExp){u=arguments[2]}else if(typeof arguments[2]==\"string\"){o=arguments[2]}else{throw new Error(\"Expected error message is not a string or RegExp.\")}}}function v(e){if(typeof e!==\"function\"){return false}var t=function(){};t.prototype=e.prototype;return new t instanceof Error}var r=false,i,s,o,u,a,f;if(typeof n!=\"function\"){throw new Error(\"Actual is not a Function\")}d.apply(null,arguments);try{n()}catch(l){r=true;i=l}if(!r){return p(\"Expected function to throw an Error.\")}if(!(i instanceof Error)){return p(\"Expected function to throw an Error, but it threw \"+i+\".\")}if(arguments.length==1){return h(\"Expected function not to throw an Error, but it threw \"+c(i)+\".\")}if(s){a=c(s);f=c(i.constructor)}if(s&&o){if(i.constructor==s&&t.equals(i.message,o)){return h(\"Expected function not to throw \"+a+\' with message \"\'+o+\'\".\')}else{return p(\"Expected function to throw \"+a+\' with message \"\'+o+\'\", but it threw \'+f+\' with message \"\'+i.message+\'\".\')}}if(s&&u){if(i.constructor==s&&u.test(i.message)){return h(\"Expected function not to throw \"+a+\" with message matching \"+u+\".\")}else{return p(\"Expected function to throw \"+a+\" with message matching \"+u+\", but it threw \"+f+\' with message \"\'+i.message+\'\".\')}}if(s){if(i.constructor==s){return h(\"Expected function not to throw \"+a+\".\")}else{return p(\"Expected function to throw \"+a+\", but it threw \"+f+\".\")}}if(o){if(i.message==o){return h(\"Expected function not to throw an exception with message \"+e.pp(o)+\".\")}else{return p(\"Expected function to throw an exception with message \"+e.pp(o)+\", but it threw an exception with message \"+e.pp(i.message)+\".\")}}if(u){if(u.test(i.message)){return h(\"Expected function not to throw an exception with a message matching \"+e.pp(u)+\".\")}else{return p(\"Expected function to throw an exception with a message matching \"+e.pp(u)+\", but it threw an exception with message \"+e.pp(i.message)+\".\")}}}}}return t};getJasmineRequireObj().version=function(){return\"2.0.0\"};getJasmineRequireObj().ConsoleReporter=function(){function r(r){function p(){i(\"\\n\")}function d(e,t){return s?h[e]+t+h.none:t}function v(e,t){return t==1?e:e+\"s\"}function m(e,t){var n=[];for(var r=0;r<t;r++){n.push(e)}return n}function g(e,t){var n=(e||\"\").split(\"\\n\");var r=[];for(var i=0;i<n.length;i++){r.push(m(\" \",t).join(\"\")+n[i])}return r.join(\"\\n\")}function y(e){for(var t=0;t<e.failedExpectations.length;t++){var n=e.failedExpectations[t]}}var i=r.print,s=r.showColors||false,o=r.onComplete||function(){},u=r.timer||n,a,f,l=[],c,h={green:\"\u001B[32m\",red:\"\u001B[31m\",yellow:\"\u001B[33m\",none:\"\u001B[0m\"};this.jasmineStarted=function(){a=0;f=0;c=0;u.start()};this.jasmineDone=function(){for(var e=0;e<l.length;e++){y(l[e])}var t=a+\" \"+v(\"spec\",a)+\", \"+f+\" \"+v(\"failure\",f);if(c){t+=\", \"+c+\" pending \"+v(\"spec\",c)}var n=u.elapsed()\/1e3;o(f===0)};this.specDone=function(n){a++;if(n.status==\"pending\"){c++;return}if(n.status==\"passed\"){i(e+\"<div class=\'jasmine-passed\'><i class=\'icon-ok-sign\'><\/i>\"+n.description+\"<\/div>\");return}if(n.status==\"failed\"){f++;l.push(n);i(e+\"<div class=\'jasmine-failed\'><i class=\'icon-remove-sign\'><\/i>\"+n.description+\"<pre>\"+t(n.failedExpectations[0])+\"<\/pre><\/div>\");window.test=n}};return this}var e=\"<<<jasmine>>>>\";var t=function(e){var t=\"\";t+=e.message?e.message:\"\";var n,r;if(e.stack){n=e.stack.split(\"\\n\")}if(n){if(n[1]){var i=n[1].search(\"at\");if(i!==-1){t+=\"\\nInside Function: \"+n[1].slice(i).split(\" \")[1]}r=n[1].split(\",\")[0].split(\":\");window.test2=r;t+=\"\\nLine: \"+r[r.length-2]+\", Column: \"+r[r.length-1].replace(\/\\)\/g,\"\")}}return t};var n={start:function(){},elapsed:function(){return 0}};return r};(function(){function s(e,t){for(var n in t)e[n]=t[n];return e}window.jasmine=jasmineRequire.core(jasmineRequire);window.env=jasmine.getEnv();var e={describe:function(e,t){return env.describe(e,t)},xdescribe:function(e,t){return env.xdescribe(e,t)},it:function(e,t){return env.it(e,t)},xit:function(e,t){return env.xit(e,t)},beforeEach:function(e){return env.beforeEach(e)},afterEach:function(e){return env.afterEach(e)},expect:function(e){return env.expect(e)},pending:function(){return env.pending()},spyOn:function(e,t){return env.spyOn(e,t)},jsApiReporter:new jasmine.JsApiReporter({timer:new jasmine.Timer})};if(typeof window==\"undefined\"&&typeof exports==\"object\"){s(exports,e)}else{s(window,e)}jasmine.addCustomEqualityTester=function(e){env.addCustomEqualityTester(e)};jasmine.addMatchers=function(e){return env.addMatchers(e)};jasmine.clock=function(){return env.clock};env.addReporter(e.jsApiReporter);var t=jasmineRequire.ConsoleReporter();var n={timer:new jasmine.Timer,print:function(){console.log.apply(console,arguments)}};var r=new t(n);env.addReporter(r);window.setTimeout=window.setTimeout;window.setInterval=window.setInterval;window.clearTimeout=window.clearTimeout;window.clearInterval=window.clearInterval;var i=window.onload;window.onload=function(){if(i){i()}}})()";
        jsrepl.eval(jasmineJS);
      }
      if(codeToEval){
        jsrepl.eval(codeToEval);
      }
    });

    return {
      eval: function(command){
        jsrepl.eval(command);
      },
      setEditorText: function(code){
        editor.setValue(code);
      }
    };

  }
  return MKSjsrepl
});